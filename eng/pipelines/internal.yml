trigger: none
pr: none

parameters:
# Set `CrossDacCoreClrVersion` to download and index against a specific version
- name: CrossDacCoreClrVersion
  type: string
  default: latest
# Set `SymStoreCrossDacIndex: true` to index the DAC for a given release
- name: SymStoreCrossDacIndex
  type: boolean
  default: true
# Set `MicrosoftSymbolUploaderBuildTaskVersion` to fix the version of the symbol task to use.
- name: MicrosoftSymbolUploaderBuildTaskVersion
  type: string
  default: 1.1.135802

variables:
- name: _DotNetArtifactsCategory
  value: CORECLR
- name: CrossDacCoreClrVersion
  value: ${{ parameters.CrossDacCoreClrVersion }}
- name: SymStoreCrossDacIndex
  value: ${{ parameters.SymStoreCrossDacIndex }}


stages:
  - stage: Prepare
    jobs:
    #
    # Cross-dac prepare
    #
    - template: /eng/platform-matrix.yml
      parameters:
        jobTemplate: build-crossdac-job.yml
        buildConfig: release
        jobParameters:
          CrossDacCoreClrVersion: ${{ parameters.CrossDacCoreClrVersion }}
        platforms:
        - Linux_arm64 # Needs an ubuntu container

  - stage: Build
    jobs:
    #
    # Cross-dac build
    #
    - template: /eng/platform-matrix.yml
      parameters:
        jobTemplate: build-crossdac-job.yml
        buildConfig: release
        dependsOn:
        - build_Linux_arm64_release
        platforms:
        - Windows_NT_arm
        - Windows_NT_arm64
        - Windows_NT_x64
        jobParameters:
          # Publishing packages to blob feeds sometimes takes a long time
          # due to waiting for an exclusive lock on the feed.
          # See https://github.com/dotnet/arcade/blob/master/Documentation/CorePackages/AsyncPublishing.md
          timeoutInMinutes: 120

    #
    # Publish build information to Build Assets Registry
    #
    # This job gathers build assets from the pipeline (from each official
    # product build job), and publishes them to the build assets
    # registry. Its dependencies should be updated to include all of the
    # official builds if we add more platform/arch combinations.
    - template: /eng/finalize-publish.yml
      parameters:
        dependsOn:
        - build_Windows_NT_x64_release
        - build_Windows_NT_arm_release
        - build_Windows_NT_arm64_release

  - ${{ if and(ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - template: /eng/common/templates/post-build/post-build.yml
      parameters:
        # Symbol validation is not entirely reliable as of yet, so should be turned off until https://github.com/dotnet/arcade/issues/2871 is resolved.
        enableSymbolValidation: false
        symbolPublishingAdditionalParameters: /p:MicrosoftSymbolUploaderBuildTaskVersion=${{ parameters.MicrosoftSymbolUploaderBuildTaskVersion }}
